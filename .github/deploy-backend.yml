# name: Deploy Backend to EC2

# on:
#   push:
#     branches:
#       - main
#       - develop
#     paths:
#       - 'backend/**'
#       - '.github/workflows/deploy-backend.yml'
#   pull_request:
#     branches:
#       - main
#       - develop
#     paths:
#       - 'backend/**'

# jobs:
#   lint-and-test:
#     name: Lint and Test Backend
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'
#           cache-dependency-path: backend/package-lock.json

#       - name: Install dependencies
#         working-directory: ./backend
#         run: npm ci

#       - name: Run tests
#         working-directory: ./backend
#         run: npm test
#         env:
#           NODE_ENV: test

#   build:
#     name: Build Backend
#     runs-on: ubuntu-latest
#     needs: lint-and-test
#     if: github.event_name == 'push'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: Install dependencies
#         working-directory: ./backend
#         run: npm ci --production

#       - name: Create deployment archive
#         run: |
#           cd backend
#           tar -czf ../backend-deploy.tar.gz .
#           cd ..

#       - name: Upload artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: backend-deploy
#           path: backend-deploy.tar.gz
#           retention-days: 1

#   deploy-production:
#     name: Deploy to EC2 Production
#     runs-on: ubuntu-latest
#     needs: build
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
#     steps:
#       - name: Download artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: backend-deploy

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Deploy to EC2
#         env:
#           EC2_HOST: ${{ secrets.EC2_PRODUCTION_HOST }}
#           EC2_USER: ${{ secrets.EC2_USER }}
#           EC2_SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#         run: |
#           # Setup SSH
#           mkdir -p ~/.ssh
#           echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
#           chmod 600 ~/.ssh/deploy_key
#           ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

#           # Upload deployment archive
#           scp -i ~/.ssh/deploy_key backend-deploy.tar.gz $EC2_USER@$EC2_HOST:/tmp/

#           # Deploy on EC2
#           ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
#             set -e
            
#             # Backup current deployment
#             if [ -d ~/app/backend ]; then
#               timestamp=$(date +%Y%m%d_%H%M%S)
#               mv ~/app/backend ~/app/backend_backup_$timestamp
#             fi

#             # Extract new deployment
#             mkdir -p ~/app/backend
#             tar -xzf /tmp/backend-deploy.tar.gz -C ~/app/backend
#             rm /tmp/backend-deploy.tar.gz

#             # Install dependencies (if not included)
#             cd ~/app/backend
#             npm ci --production

#             # Reload PM2
#             pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

#             # Cleanup old backups (keep last 3)
#             cd ~/app
#             ls -dt backend_backup_* | tail -n +4 | xargs rm -rf

#             echo "Deployment completed successfully!"
#           ENDSSH

#       - name: Health check
#         run: |
#           sleep 10
#           curl -f ${{ secrets.PRODUCTION_API_URL }}/health || exit 1

#     name: Deploy to EC2 Staging
#     runs-on: ubuntu-latest
#     needs: build
#     if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
#     steps:
#       - name: Download artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: backend-deploy

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Deploy to EC2
#         env:
#           EC2_HOST: ${{ secrets.EC2_STAGING_HOST }}
#           EC2_USER: ${{ secrets.EC2_USER }}
#           EC2_SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#         run: |
#           # Setup SSH
#           mkdir -p ~/.ssh
#           echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
#           chmod 600 ~/.ssh/deploy_key
#           ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

#           # Upload deployment archive
#           scp -i ~/.ssh/deploy_key backend-deploy.tar.gz $EC2_USER@$EC2_HOST:/tmp/

#           # Deploy on EC2
#           ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
#             set -e
            
#             # Extract new deployment
#             mkdir -p ~/app/backend
#             tar -xzf /tmp/backend-deploy.tar.gz -C ~/app/backend
#             rm /tmp/backend-deploy.tar.gz

#             # Install dependencies
#             cd ~/app/backend
#             npm ci --production

#             # Reload PM2
#             pm2 reload ecosystem.config.js --env staging || pm2 start ecosystem.config.js --env staging

#             echo "Staging deployment completed!"
#           ENDSSH

#       - name: Health check
#         run: |
#           sleep 10
#           curl -f ${{ secrets.STAGING_API_URL }}/health || exit 1